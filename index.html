<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beev - solar farm ☀️</title>

    <style>
      caption {
        display: block;
        text-align: left;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }

      th {
        text-align: left;
        padding-right: 1rem;
      }

      button {
        margin-top: 1rem;
      }

      .highlight {
        background-color: green;
      }
    </style>
  </head>
  <body>
    <table>
      <caption style="display: block">
        Sensor data
      </caption>
      <tr>
        <th id="timestamp">Timestamp</th>
      </tr>
      <tr>
        <th id="luminosity">Luminosity index</th>
      </tr>
    </table>
    <button onclick="benchmark(fetchLatestMeasures)">
      Fetch latest measures
    </button>
    <button onclick="benchmark(analyzeProductionPatterns)">
      Find the optimum production time
    </button>

    <hr />
    <div id="benchmark"></div>

    <script>
      window.localStorage.removeItem("latestMeasure");

      async function benchmark(callback) {
        const startTime = performance.now();
        await callback();
        const endTime = performance.now();

        // time in milliseconds
        const duration = endTime - startTime;

        const benchmarkDiv = document.querySelector("#benchmark");
        benchmarkDiv.innerText = `Benchmark: ${duration}ms`;

        return duration;
      }

      async function fetchLatestMeasures() {
        const timestampTableHeader = document.querySelector("#timestamp");
        const luminosityTableHeader = document.querySelector("#luminosity");

        console.log(timestampTableHeader);
        console.log(luminosityTableHeader);

        const serializedLatestMeasure =
          window.localStorage.getItem("latestMeasure");

        let measures = [];

        console.log("MEAsURE  ", serializedLatestMeasure);

        // If the value in localstorage is not present we want to fetch all measures
        // Else we want to fetch only latest values by providing the latestMeasure timestamp
        if (serializedLatestMeasure === null) {
          const response = await fetch("/luminosity/all");
          measures = await response.json();
          console.log(measures);

          if (measures.length > 0) {
            const latestMeasure = measures.at(-1);
            window.localStorage.setItem(
              "latestMeasure",
              JSON.stringify(latestMeasure)
            );
            console.log(latestMeasure);
          }
        } else {
          const deserializedLatestMeasure = JSON.parse(serializedLatestMeasure);
          const response = await fetch(
            `/luminosity/latest?timestamp=${deserializedLatestMeasure.timestamp}`
          );
          measures = await response.json();
          console.log(measures);

          if (measures.length > 0) {
            const latestMeasure = measures.at(-1);
            window.localStorage.setItem(
              "latestMeasure",
              JSON.stringify(latestMeasure)
            );
            console.log(latestMeasure);
          }
        }

        measures.forEach((measure) => {
          const newTimestampCell = document.createElement("td");
          const newLuminosityCell = document.createElement("td");

          newTimestampCell.innerText = new Date(
            measure.timestamp
          ).toLocaleTimeString("en-US", { hour12: false });
          newLuminosityCell.innerText = measure.value;

          newTimestampCell.setAttribute("data-id", measure.id);
          newLuminosityCell.setAttribute("data-id", measure.id);

          timestampTableHeader.insertAdjacentElement(
            "afterend",
            newTimestampCell
          );

          luminosityTableHeader.insertAdjacentElement(
            "afterend",
            newLuminosityCell
          );
        });
      }

      async function analyzeProductionPatterns() {
        const response = await fetch(`/luminosity/analyze`);
        bestMeasures = await response.json();
        console.log(bestMeasures);

        const ids = bestMeasures.map((measure) => measure.id);

        console.log(ids);
        // clean classes before highlighting
        document
          .querySelectorAll("[data-id]")
          .forEach((element) => element.classList.remove("highlight"));

        // Construct the CSS selector
        const selector = ids.map((id) => `[data-id="${id}"]`).join(",");

        console.log(selector);

        // Use querySelectorAll with the selector
        const elements = document.querySelectorAll(selector);

        // Iterate over the selected elements
        elements.forEach((element) => {
          // Do something with each element
          console.log(element.style);
          element.classList.add("highlight");
        });

        // faire une boucle pour highlight le subset
      }
    </script>
  </body>
</html>
